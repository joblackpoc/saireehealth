{% extends 'base.html' %}

{% block title %}History - Health Progress{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-clock-history"></i> ประวัติข้อมูลสุขภาพ</h2>

<!-- Graph Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">กราฟและการวิเคราะห์</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">เลือกข้อมูล</label>
                <select name="metric" class="form-select" onchange="this.form.submit()">
                    <option value="bmi" {% if metric_filter == 'bmi' %}selected{% endif %}>BMI</option>
                    <option value="fat_percent" {% if metric_filter == 'fat_percent' %}selected{% endif %}>เปอร์เซ็นต์ไขมัน</option>
                    <option value="visceral_fat" {% if metric_filter == 'visceral_fat' %}selected{% endif %}>ไขมันในช่องท้อง</option>
                    <option value="muscle_percent" {% if metric_filter == 'muscle_percent' %}selected{% endif %}>เปอร์เซ็นต์กล้ามเนื้อ</option>
                    <option value="blood_pressure_systolic" {% if metric_filter == 'blood_pressure_systolic' %}selected{% endif %}>ความดันบน</option>
                    <option value="blood_pressure_diastolic" {% if metric_filter == 'blood_pressure_diastolic' %}selected{% endif %}>ความดันล่าง</option>
                    <option value="waist" {% if metric_filter == 'waist' %}selected{% endif %}>เส้นรอบเอว</option>
                    <option value="cholesterol" {% if metric_filter == 'cholesterol' %}selected{% endif %}>Cholesterol</option>
                    <option value="ldl" {% if metric_filter == 'ldl' %}selected{% endif %}>LDL</option>
                    <option value="hdl" {% if metric_filter == 'hdl' %}selected{% endif %}>HDL</option>
                    <option value="fbs" {% if metric_filter == 'fbs' %}selected{% endif %}>FBS</option>
                    <option value="triglycerides" {% if metric_filter == 'triglycerides' %}selected{% endif %}>Triglycerides</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">วันที่เริ่มต้น</label>
                <input type="date" name="date_start" class="form-control" value="{{ date_start }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">วันที่สิ้นสุด</label>
                <input type="date" name="date_end" class="form-control" value="{{ date_end }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel"></i> กรอง
                </button>
            </div>
        </form>
        
        {% if graph_base64 %}
        <div class="mt-4">
            <img src="data:image/png;base64,{{ graph_base64 }}" alt="Health Graph" class="img-fluid w-100" style="max-width: 100%; height: auto;">
        </div>
        {% endif %}
    </div>
</div>

<!-- Comparison Table -->
{% if comparison_data %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">ตารางเปรียบเทียบ</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>ประเภท</th>
                        <th>วันที่เริ่มต้น ({{ first_record.recorded_at|date:"Y-m-d" }})</th>
                        <th>วันที่สิ้นสุด ({{ last_record.recorded_at|date:"Y-m-d" }})</th>
                        <th>ผลการเปรียบเทียบ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>BMI</strong></td>
                        <td>{{ comparison_data.bmi.start_value }}</td>
                        <td>{{ comparison_data.bmi.end_value }}</td>
                        <td style="background-color: {{ comparison_data.bmi.color }}; color: white;">
                            <strong>{{ comparison_data.bmi.text }}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>เปอร์เซ็นต์ไขมัน</strong></td>
                        <td>{{ comparison_data.fat_percent.start_value }}%</td>
                        <td>{{ comparison_data.fat_percent.end_value }}%</td>
                        <td style="background-color: {{ comparison_data.fat_percent.color }}; color: white;">
                            <strong>{{ comparison_data.fat_percent.text }}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>ไขมันในช่องท้อง</strong></td>
                        <td>{{ comparison_data.visceral_fat.start_value }}</td>
                        <td>{{ comparison_data.visceral_fat.end_value }}</td>
                        <td style="background-color: {{ comparison_data.visceral_fat.color }}; color: white;">
                            <strong>{{ comparison_data.visceral_fat.text }}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>เปอร์เซ็นต์กล้ามเนื้อ</strong></td>
                        <td>{{ comparison_data.muscle_percent.start_value }}%</td>
                        <td>{{ comparison_data.muscle_percent.end_value }}%</td>
                        <td style="background-color: {{ comparison_data.muscle_percent.color }}; color: white;">
                            <strong>{{ comparison_data.muscle_percent.text }}</strong>
                        </td>
                    </tr>
                    {% if comparison_data.blood_pressure_systolic %}
                    <tr>
                        <td><strong>ความดันบน</strong></td>
                        <td>{{ comparison_data.blood_pressure_systolic.start_value }}</td>
                        <td>{{ comparison_data.blood_pressure_systolic.end_value }}</td>
                        <td style="background-color: {{ comparison_data.blood_pressure_systolic.color }}; color: white;">
                            <strong>{{ comparison_data.blood_pressure_systolic.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    {% if comparison_data.blood_pressure_diastolic %}
                    <tr>
                        <td><strong>ความดันล่าง</strong></td>
                        <td>{{ comparison_data.blood_pressure_diastolic.start_value }}</td>
                        <td>{{ comparison_data.blood_pressure_diastolic.end_value }}</td>
                        <td style="background-color: {{ comparison_data.blood_pressure_diastolic.color }}; color: white;">
                            <strong>{{ comparison_data.blood_pressure_diastolic.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    {% if comparison_data.waist %}
                    <tr>
                        <td><strong>เส้นรอบเอว</strong></td>
                        <td>{{ comparison_data.waist.start_value }} cm</td>
                        <td>{{ comparison_data.waist.end_value }} cm</td>
                        <td style="background-color: {{ comparison_data.waist.color }}; color: white;">
                            <strong>{{ comparison_data.waist.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    {% if comparison_data.cholesterol %}
                    <tr>
                        <td><strong>Cholesterol</strong></td>
                        <td>{{ comparison_data.cholesterol.start_value }} mg/dL</td>
                        <td>{{ comparison_data.cholesterol.end_value }} mg/dL</td>
                        <td style="background-color: {{ comparison_data.cholesterol.color }}; color: white;">
                            <strong>{{ comparison_data.cholesterol.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    {% if comparison_data.ldl %}
                    <tr>
                        <td><strong>LDL</strong></td>
                        <td>{{ comparison_data.ldl.start_value }} mg/dL</td>
                        <td>{{ comparison_data.ldl.end_value }} mg/dL</td>
                        <td style="background-color: {{ comparison_data.ldl.color }}; color: white;">
                            <strong>{{ comparison_data.ldl.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    {% if comparison_data.hdl %}
                    <tr>
                        <td><strong>HDL</strong></td>
                        <td>{{ comparison_data.hdl.start_value }} mg/dL</td>
                        <td>{{ comparison_data.hdl.end_value }} mg/dL</td>
                        <td style="background-color: {{ comparison_data.hdl.color }}; color: white;">
                            <strong>{{ comparison_data.hdl.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    {% if comparison_data.fbs %}
                    <tr>
                        <td><strong>FBS</strong></td>
                        <td>{{ comparison_data.fbs.start_value }} mg/dL</td>
                        <td>{{ comparison_data.fbs.end_value }} mg/dL</td>
                        <td style="background-color: {{ comparison_data.fbs.color }}; color: white;">
                            <strong>{{ comparison_data.fbs.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    {% if comparison_data.triglycerides %}
                    <tr>
                        <td><strong>Triglycerides</strong></td>
                        <td>{{ comparison_data.triglycerides.start_value }} mg/dL</td>
                        <td>{{ comparison_data.triglycerides.end_value }} mg/dL</td>
                        <td style="background-color: {{ comparison_data.triglycerides.color }}; color: white;">
                            <strong>{{ comparison_data.triglycerides.text }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Summary Information -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">สรุปข้อมูล</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.bmi.color }}; color: white;">
                    <strong>{{ summary_info.bmi }}</strong>
                   
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.waist.color }}; color: white;">
                    <strong>{{ summary_info.waist }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.blood_pressure_systolic.color }}; color: white;">
                    <strong>{{ summary_info.blood_pressure_systolic }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.blood_pressure_systolic.color }}; color: white;">
                    <strong>{{ summary_info.blood_pressure_systolic }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.blood_pressure_diastolic.color }}; color: white;">
                    <strong>{{ summary_info.blood_pressure_diastolic }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.fat_percent.color }}; color: white;">
                    <strong>{{ summary_info.fat_percent }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.visceral_fat.color }}; color: white;">
                    <strong>{{ summary_info.visceral_fat }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.muscle_percent.color }}; color: white;">
                    <strong>{{ summary_info.muscle_percent }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.cholesterol.color }}; color: white;">
                    <strong>{{ summary_info.cholesterol }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.ldl.color }}; color: white;">
                    <strong>{{ summary_info.ldl }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.hdl.color }}; color: white;">
                    <strong>{{ summary_info.hdl }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.fbs.color }}; color: white;">
                    <strong>{{ summary_info.fbs }}</strong>
                    
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="alert" style="background-color: {{ comparison_data.triglycerides.color }}; color: white;">
                    <strong>{{ summary_info.triglycerides }}</strong>
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Records List -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">รายการข้อมูลทั้งหมด</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>วันที่</th>
                        <th>BMI</th>
                        <th>Fat %</th>
                        <th>Visceral Fat</th>
                        <th>Muscle %</th>
                        <th>BP</th>
                        <th>Waist</th>
                        <th>Chol</th>
                        <th>LDL</th>
                        <th>HDL</th>
                        <th>FBS</th>
                        <th>Triglycerides</th>
                        <th>การจัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record.recorded_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ record.bmi }}</td>
                        <td>{{ record.fat_percent }}%</td>
                        <td>{{ record.visceral_fat }}</td>
                        <td>{{ record.muscle_percent }}%</td>
                        <td>{{ record.blood_pressure_systolic }}/{{ record.blood_pressure_diastolic }}</td>
                        <td>{{ record.waist }}</td>
                        <td>{% if record.cholesterol %}{{ record.cholesterol }}{% else %}-{% endif %}</td>
                        <td>{% if record.ldl %}{{ record.ldl }}{% else %}-{% endif %}</td>
                        <td>{% if record.hdl %}{{ record.hdl }}{% else %}-{% endif %}</td>
                        <td>{% if record.fbs %}{{ record.fbs }}{% else %}-{% endif %}</td>
                        <td>{% if record.triglycerides %}{{ record.triglycerides }}{% else %}-{% endif %}</td>
                        <td>
                            <a href="{% url 'health_app:update_record' record.id %}" class="btn btn-sm btn-primary">
                                <i class="bi bi-pencil"></i> แก้ไข
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
