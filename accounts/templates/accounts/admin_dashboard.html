{% extends 'base.html' %}

{% block title %}Admin Dashboard - Health Progress{% endblock %}

{% block content %}
<h2 class="mb-4 text-danger fw-bold">
    <i class="bi bi-shield-lock-fill"></i> Admin Dashboard
</h2>

<!-- Quick Access Buttons -->
<div class="row mb-4">
    {% comment %} <div class="col-md-4 mb-2">
        <a href="{% url 'security_enhancements:realtime_dashboard' %}" class="btn btn-danger w-100 shadow">
            <i class="bi bi-shield-exclamation-fill"></i> Realtime Security Dashboard
        </a>
    </div> {% endcomment %}
    <div class="col-md-6 mb-2">
        <a href="{% url 'health_app:health_report' %}" class="btn btn-primary w-100 shadow">
            <i class="bi bi-clipboard-data-fill"></i> รายงานตัวชี้วัด
        </a>
    </div>
    <div class="col-md-6 mb-2">
        <a href="{% url 'health_app:health_status_report' %}" class="btn btn-success w-100 shadow">
            <i class="bi bi-clipboard-check-fill"></i> รายงานสถานะสุขภาพ
        </a>
    </div>
</div>

<!-- Security Enhancement Quick Access -->
<div class="row mb-4">
    <div class="col-12">
        <a href="{% url 'accounts:enhance_security' %}" class="btn btn-warning w-100 shadow-lg" style="font-size: 1.125rem; padding: 1rem;">
            <i class="bi bi-shield-lock-fill"></i> Security Enhancement Analysis - ข้อมูลความปลอดภัยครบวงจร
        </a>
    </div>
</div>
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card shadow-lg text-white" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
            <div class="card-body text-center p-4">
                <i class="bi bi-people-fill" style="font-size: 3rem;"></i>
                <h2 class="mt-3 fw-bold">{{ total_users }}</h2>
                <p class="mb-0" style="font-size: 1.125rem;">ผู้ใช้ทั้งหมด</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card shadow-lg text-white" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
            <div class="card-body text-center p-4">
                <i class="bi bi-person-check-fill" style="font-size: 3rem;"></i>
                <h2 class="mt-3 fw-bold">{{ active_users }}</h2>
                <p class="mb-0" style="font-size: 1.125rem;">ผู้ใช้ที่ใช้งาน</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card shadow-lg text-white" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <div class="card-body text-center p-4">
                <i class="bi bi-hourglass-split" style="font-size: 3rem;"></i>
                <h2 class="mt-3 fw-bold">{{ pending_users }}</h2>
                <p class="mb-0" style="font-size: 1.125rem;">รออนุมัติ</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card shadow-lg text-white" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
            <div class="card-body text-center p-4">
                <i class="bi bi-person-x-fill" style="font-size: 3rem;"></i>
                <h2 class="mt-3 fw-bold">{{ banned_users }}</h2>
                <p class="mb-0" style="font-size: 1.125rem;">ถูกระงับ</p>
            </div>
        </div>
    </div>
</div>

<!-- Admin Navigation Menu -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-lg">
            <div class="card-header bg-dark text-white">
                <h4 class="mb-0"><i class="bi bi-menu-button-wide-fill"></i> เมนูการจัดการ</h4>
            </div>
            <div class="card-body p-0">
                <div class="row g-0">
                    <!-- Health Reports Menu -->
                    <div class="col-md-6">
                        <div class="p-4 border-end">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-clipboard-data-fill"></i> รายงานสุขภาพ
                            </h5>
                            <div class="list-group list-group-flush">
                                <a href="{% url 'health_app:health_report' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="bi bi-clipboard-data text-primary" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">รายงานตัวชี้วัดสุขภาพ</h6>
                                        <small class="text-muted">ค้นหาผู้ใช้ตามช่วงค่าที่กำหนด (BMI, ความดัน, ฯลฯ)</small>
                                    </div>
                                </a>
                                <a href="{% url 'health_app:health_status_report' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="bi bi-clipboard-check text-success" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">รายงานสถานะสุขภาพ</h6>
                                        <small class="text-muted">จำแนกผู้ใช้ตามสถานะ: ปกติ/ผิดปกติ พร้อมสถิติ</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Management Menu -->
                    <div class="col-md-6">
                        <div class="p-4">
                            <h5 class="text-danger mb-3">
                                <i class="bi bi-shield-lock-fill"></i> การจัดการระบบ
                            </h5>
                            <div class="list-group list-group-flush">
                                <a href="{% url 'security_enhancements:realtime_dashboard' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="bi bi-shield-exclamation text-danger" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Realtime Security Intelligence Dashboard</h6>
                                        <small class="text-muted">ตรวจสอบความปลอดภัยแบบเรียลไทม์และการวิเคราะห์ภัยคุกคาม</small>
                                    </div>
                                </a>
                                <a href="{% url 'accounts:enhance_security' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="bi bi-shield-lock text-warning" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Security Enhancement Analysis</h6>
                                        <small class="text-muted">รายงานความปลอดภัยแบบครcomprehensive พร้อมข้อมูลทั้งหมด</small>
                                    </div>
                                </a>
                                <a href="{% url 'accounts:user_create' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="bi bi-person-plus text-info" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">เพิ่มผู้ใช้ใหม่</h6>
                                        <small class="text-muted">สร้างบัญชีผู้ใช้ใหม่ในระบบ</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Reports Card -->
<div class="card mb-4 shadow-lg">
    <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <h4 class="mb-0 text-white"><i class="bi bi-clipboard-data-fill"></i> ระบบรายงานสุขภาพ</h4>
    </div>
    <div class="card-body p-4">
        <div class="row">
            <!-- Health Indicator Report -->
            <div class="col-md-6">
                <div class="text-center mb-3">
                    <h5 class="text-primary">รายงานตัวชี้วัดสุขภาพ</h5>
                    <p class="text-muted mb-3">
                        ค้นหาผู้ใช้ตามช่วงค่าที่กำหนด เช่น BMI 25-30, ความดัน 120-140
                    </p>
                    <div class="d-flex flex-wrap gap-1 justify-content-center mb-3">
                        <span class="badge bg-light text-dark">Range Filtering</span>
                        <span class="badge bg-light text-dark">16 Indicators</span>
                        <span class="badge bg-light text-dark">Custom Values</span>
                    </div>
                    <a href="{% url 'health_app:health_report' %}" class="btn btn-primary btn-lg shadow">
                        <i class="bi bi-clipboard-data-fill"></i><br>
                        <small>รายงานตัวชี้วัด</small>
                    </a>
                </div>
            </div>
            
            <!-- Health Status Report -->
            <div class="col-md-6">
                <div class="text-center mb-3">
                    <h5 class="text-success">รายงานสถานะสุขภาพ</h5>
                    <p class="text-muted mb-3">
                        จำแนกผู้ใช้ตามสถานะ: ปกติ/ผิดปกติ พร้อมสถิติและการส่งออก
                    </p>
                    <div class="d-flex flex-wrap gap-1 justify-content-center mb-3">
                        <span class="badge bg-light text-dark">Normal/Abnormal</span>
                        <span class="badge bg-light text-dark">Statistics</span>
                        <span class="badge bg-light text-dark">Multi-sheet Excel</span>
                    </div>
                    <a href="{% url 'health_app:health_status_report' %}" class="btn btn-success btn-lg shadow">
                        <i class="bi bi-clipboard-check-fill"></i><br>
                        <small>รายงานสถานะ</small>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i> 
                รายงานทั้งสองแบบสามารถส่งออกเป็นไฟล์ Excel ได้
            </small>
        </div>
    </div>
</div>

<!-- User Management Card -->
<div class="card mb-4 shadow-lg">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <h4 class="mb-2 mb-md-0"><i class="bi bi-people-fill"></i> จัดการผู้ใช้</h4>
        <a href="{% url 'accounts:user_create' %}" class="btn btn-success shadow">
            <i class="bi bi-plus-circle-fill"></i> เพิ่มผู้ใช้
        </a>
    </div>
    <div class="card-body p-4">
        <!-- Filters -->
        <form method="get" class="row g-3 mb-4">
            <div class="col-md-3">
                <label class="form-label fw-bold">สถานะ</label>
                <select name="status" class="form-select">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>ทั้งหมด</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>ใช้งาน</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>รอการยืนยัน</option>
                    <option value="banned" {% if status_filter == 'banned' %}selected{% endif %}>ถูกระงับ</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">บทบาท</label>
                <select name="role" class="form-select">
                    <option value="all" {% if role_filter == 'all' %}selected{% endif %}>ทั้งหมด</option>
                    <option value="normal" {% if role_filter == 'normal' %}selected{% endif %}>ผู้ใช้ทั่วไป</option>
                    <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
                    <option value="superuser" {% if role_filter == 'superuser' %}selected{% endif %}>Superuser</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">ค้นหา</label>
                <input type="text" name="search" class="form-control" placeholder="ค้นหาชื่อหรือ username..." value="{{ search_query }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel-fill"></i> กรอง
                </button>
            </div>
        </form>
        
        <!-- Users Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="font-size: 1.125rem;">Username</th>
                        <th style="font-size: 1.125rem;">ชื่อ-นามสกุล</th>
                        <th style="font-size: 1.125rem;">บทบาท</th>
                        <th style="font-size: 1.125rem;">สถานะ</th>
                        <th style="font-size: 1.125rem;">จัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td style="font-size: 1.125rem;">
                            <i class="bi bi-person-circle text-primary"></i> {{ u.username }}
                        </td>
                        <td style="font-size: 1.125rem;">{{ u.profile.firstname }} {{ u.profile.lastname }}</td>
                        <td>
                            <span class="badge bg-{% if u.profile.role == 'superuser' %}danger{% elif u.profile.role == 'admin' %}warning{% else %}success{% endif %}" style="font-size: 1rem;">
                                {{ u.profile.get_role_display }}
                            </span>
                        </td>
                        <td>
                            {% if u.profile.is_banned %}
                                <span class="badge bg-danger" style="font-size: 1rem;">ถูกระงับ</span>
                            {% elif u.profile.is_active_status %}
                                <span class="badge bg-success" style="font-size: 1rem;">ใช้งาน</span>
                            {% else %}
                                <span class="badge bg-warning" style="font-size: 1rem;">รออนุมัติ</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'accounts:user_management' u.id %}" class="btn btn-sm btn-primary shadow-sm mb-1">
                                <i class="bi bi-gear-fill"></i> จัดการ
                            </a>
                            <a href="{% url 'accounts:user_delete' u.id %}" class="btn btn-sm btn-danger shadow-sm mb-1" 
                               onclick="return confirm('ต้องการลบผู้ใช้นี้หรือไม่?')">
                                <i class="bi bi-trash-fill"></i> ลบ
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Recent Activities Card -->
<div class="card shadow-lg">
    <div class="card-header">
        <h4 class="mb-0"><i class="bi bi-clock-history"></i> กิจกรรมล่าสุด</h4>
    </div>
    <div class="card-body p-4">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th style="font-size: 1.125rem;">ผู้ใช้</th>
                        <th style="font-size: 1.125rem;">กิจกรรม</th>
                        <th style="font-size: 1.125rem;">IP Address</th>
                        <th style="font-size: 1.125rem;">เวลา</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in recent_activities %}
                    <tr>
                        <td style="font-size: 1rem;">
                            <i class="bi bi-person-circle text-success"></i> {{ activity.user.username }}
                        </td>
                        <td style="font-size: 1rem;">{{ activity.get_action_display }}</td>
                        <td style="font-size: 1rem;"><code>{{ activity.ip_address }}</code></td>
                        <td style="font-size: 1rem;">{{ activity.created_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}